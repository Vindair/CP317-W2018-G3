{% extends 'application/base.html' %}

{% block content %}
    <div class="jumbotron jumbo-container">
        <div class="container-fluid search-sublet-main-container">
            <div class="row">
                <div class="col">
                    <h2>
                        Search Results: {{ place.count }} results found
                    </h2>
                    <button type="button" data-toggle="collapse" data-target="#filterToggler"
                            class="btn btn-secondary btn-sm" aria-controls="filterToggler" aria-expanded="false"
                            aria-label="Toggle navigation">
                        Advanced filters
                    </button>
                    <div class="collapse" id="filterToggler">
                        <div class="bg-dark p-4 mt-2" style="border-radius: 5px;">
                            <h6 class="text-white">Advanced Filters</h6>
                            <form action="{% url 'subby:search' %}" method="POST">
                                {% csrf_token %}
                                <div class="form-group text-light">
                                    <input type="hidden" name="lat" value="{{ lat }}">
                                    <input type="hidden" name="lng" value="{{ lng }}">
                                    <label for="prox">Proximity (km):</label>
                                    <input class="form-control" name="proximity" id="prox" type="number" min="1"
                                           value="{{ prox }}">
                                    <button class="btn btn-secondary btn-sm mt-3" type="submit">Filter</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <br><br>
                    <div class="container-fluid search-container">
                        {% for p in place %}
                            <div class="card gallery" style="width: 18rem;">
                                {% load index %}
                                <img class="card-img-top" src="{{ cover|index:forloop.counter0 }}" alt="">
                                <div class="card-body">
                                    <h5 class="card-title">{{ p.title }}</h5>
                                    <p class="card-text">{{ p.description }}</p>
                                </div>
                                <div class="card-footer"><a href="{% url 'subby:SubletDetail' p.id %}"
                                                            class="btn btn-primary d-block mx-auto view-listing-btn">View
                                    Listing</a></div>
                                <div class="card-footer text-center text-muted">${{ p.price }} per month</div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col">
                    <div id="map" style="min-height: 100%; height: auto;"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script>
        function init_searchmap() {

            let myOptions = {
                center: new google.maps.LatLng({{ lat }}, {{ lng }}),
                zoom: 17,
                mapTypeId: google.maps.MapTypeId.ROADMAP

            };
            let map = new google.maps.Map(document.getElementById("map"),
                myOptions);
            let bounds = new google.maps.LatLngBounds();
            setMarkers(map, bounds)

        }


        function setMarkers(map, bounds) {

            {%  for p in place %}
                latlngset = new google.maps.LatLng({{ p.latitude }}, {{ p.longitude }});
                marker = new google.maps.Marker({
                    map: map, title: '{{ p.title }}', position: latlngset
                });
                map.setCenter(marker.getPosition());

                content = "Listing Name: {{ p.title }}" + '<br>' + "Address: {{ p.street_address }}" + '<br>' + " City: {{ p.city }}" + '<br>' +
                    'Price: ${{ p.price }}/mo';

                infowindow = new google.maps.InfoWindow();

                google.maps.event.addListener(marker, 'click', (function (marker, content, infowindow) {
                    return function () {
                        infowindow.setContent(content);
                        infowindow.open(map, marker);
                    };
                })(marker, content, infowindow));

                bounds.extend(marker.getPosition());

                map.fitBounds(bounds);
            {% endfor %}

        }
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"
            integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T"
            crossorigin="anonymous"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWKqqOWg7D2pCCKgsGe_ISDMUyEkkxXzY&libraries=places&callback=init_searchmap"
            async defer></script>
{% endblock %}